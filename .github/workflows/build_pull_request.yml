name: Build Pull Request

on:
  pull_request:
    branches:
      - "**"
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request Number'
        required: true
        type: string
      target_branch:
        description: 'Target Branch (default: dev)'
        required: false
        default: 'dev'
        type: string

jobs:
  build-and-comment:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Extract PR information
        id: extract-pr
        run: |
          # Determine if this is a manual trigger or PR trigger
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Manual trigger detected"
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
            TARGET_BRANCH="${{ github.event.inputs.target_branch }}"
            
            # Get PR information from GitHub API
            PR_URL="https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER"
            echo "Fetching PR info from: $PR_URL"
            
            PR_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "$PR_URL")
            
            HEAD_REF=$(echo "$PR_JSON" | jq -r '.head.ref')
            HEAD_SHA=$(echo "$PR_JSON" | jq -r '.head.sha')
            HEAD_REPO_FULL_NAME=$(echo "$PR_JSON" | jq -r '.head.repo.full_name')
            
            BASE_REF="$TARGET_BRANCH"
            IS_MANUAL_TRIGGER="true"
          else
            echo "PR trigger detected"
            PR_NUMBER=${{ github.event.pull_request.number }}
            HEAD_REF="${{ github.event.pull_request.head.ref }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            HEAD_REPO_FULL_NAME="${{ github.event.pull_request.head.repo.full_name }}"
            BASE_REF="${{ github.event.pull_request.base.ref }}"
            
            IS_MANUAL_TRIGGER="false"
          fi
          
          # Short SHA (7 characters)
          SHORT_SHA="${HEAD_SHA:0:7}"
          
          # Output variables
          echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "head-ref=$HEAD_REF" >> $GITHUB_OUTPUT
          echo "head-sha=$HEAD_SHA" >> $GITHUB_OUTPUT
          echo "short-sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "head-repo=$HEAD_REPO_FULL_NAME" >> $GITHUB_OUTPUT
          echo "base-ref=$BASE_REF" >> $GITHUB_OUTPUT
          echo "manual-trigger=$IS_MANUAL_TRIGGER" >> $GITHUB_OUTPUT
          
          # Create commit URL
          COMMIT_URL="https://github.com/${{ github.repository }}/pull/$PR_NUMBER/commits/$HEAD_SHA"
          echo "commit-url=$COMMIT_URL" >> $GITHUB_OUTPUT
          
      - name: Check for existing comment
        id: find-comment
        run: |
          PR_NUMBER=${{ steps.extract-pr.outputs.pr-number }}
          REPO="${{ github.repository }}"
          
          # Get existing comments
          COMMENTS_URL="https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments"
          echo "Fetching comments from: $COMMENTS_URL"
          
          COMMENTS_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "$COMMENTS_URL")
          
          # Look for comment from GitHub Actions bot that contains "ArchiveTune Test Build"
          COMMENT_ID=$(echo "$COMMENTS_JSON" | jq -r '.[] | select(.user.login == "github-actions[bot]") | select(.body | contains("ArchiveTune Test Build")) | .id' | head -1)
          
          if [ -n "$COMMENT_ID" ] && [ "$COMMENT_ID" != "null" ]; then
            echo "Found existing comment ID: $COMMENT_ID"
            echo "comment-id=$COMMENT_ID" >> $GITHUB_OUTPUT
            echo "comment-exists=true" >> $GITHUB_OUTPUT
            
            # Get the full comment body to check if it's for the current SHA
            COMMENT_BODY=$(echo "$COMMENTS_JSON" | jq -r ".[] | select(.id == $COMMENT_ID) | .body")
            CURRENT_SHA="${{ steps.extract-pr.outputs.head-sha }}"
            
            if echo "$COMMENT_BODY" | grep -q "$CURRENT_SHA"; then
              echo "Comment already exists for this SHA"
              echo "same-sha=true" >> $GITHUB_OUTPUT
            else
              echo "Comment exists but for different SHA"
              echo "same-sha=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No existing comment found"
            echo "comment-exists=false" >> $GITHUB_OUTPUT
            echo "same-sha=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Get workflow job info for raw logs
        id: job-info
        run: |
          # Get current workflow run jobs
          RUN_JOBS_URL="https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs"
          
          echo "Fetching jobs info from: $RUN_JOBS_URL"
          
          JOBS_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "$RUN_JOBS_URL")
          
          # Find the current job (build-and-comment)
          JOB_ID=$(echo "$JOBS_JSON" | jq -r '.jobs[] | select(.name == "build-and-comment") | .id')
          
          if [ -n "$JOB_ID" ] && [ "$JOB_ID" != "null" ]; then
            echo "Found job ID: $JOB_ID"
            echo "job-id=$JOB_ID" >> $GITHUB_OUTPUT
            
            # Create raw logs URL
            # Format 1: Direct job logs URL (works for GitHub Actions)
            RAW_LOGS_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/job/$JOB_ID"
            echo "raw-logs-url=$RAW_LOGS_URL" >> $GITHUB_OUTPUT
            
            # Format 2: Alternative API URL for raw logs
            API_LOGS_URL="https://api.github.com/repos/${{ github.repository }}/actions/jobs/$JOB_ID/logs"
            echo "api-logs-url=$API_LOGS_URL" >> $GITHUB_OUTPUT
            
            # Format 3: Simple workflow URL with job name
            SIMPLE_LOGS_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}?check_suite_focus=true"
            echo "simple-logs-url=$SIMPLE_LOGS_URL" >> $GITHUB_OUTPUT
          else
            echo "Warning: Could not find job ID"
            echo "job-id=0" >> $GITHUB_OUTPUT
            echo "raw-logs-url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT
            echo "api-logs-url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT
            echo "simple-logs-url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT
          fi
          
      - name: Create or update comment - Starting build
        id: initial-comment
        uses: peter-evans/create-or-update-comment@v5
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ steps.extract-pr.outputs.pr-number }}
          edit-mode: replace
          body: |
            # <img src="https://raw.githubusercontent.com/koiverse/ArchiveTune/main/fastlane/metadata/android/en-US/images/icon.png" width="50" height="50" alt="ArchiveTune Logo" style="border-radius: 22%"> ArchiveTune Test Build
            
            ${{ steps.extract-pr.outputs.manual-trigger == 'true' && 'ğŸ”§ **Build triggered manually!**' || 'ğŸš€ **Build triggered by new commit!**' }}
            
            **Status:** â³ Starting build process...
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** `${{ steps.extract-pr.outputs.head-ref }}` â†’ `${{ steps.extract-pr.outputs.base-ref }}`
            **Commit SHA:** [<code>${{ steps.extract-pr.outputs.short-sha }}</code>](${{ steps.extract-pr.outputs.commit-url }})
            
            â³ I'll update this message as the build progresses.
            
            ---
            *Current step:* Initializing build environment...
            
      - name: Update comment - Building
        uses: peter-evans/create-or-update-comment@v5
        with:
          comment-id: ${{ steps.initial-comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            # <img src="https://raw.githubusercontent.com/koiverse/ArchiveTune/main/fastlane/metadata/android/en-US/images/icon.png" width="50" height="50" alt="ArchiveTune Logo" style="border-radius: 22%"> ArchiveTune Test Build
            
            ${{ steps.extract-pr.outputs.manual-trigger == 'true' && 'ğŸ”§ **Build triggered manually!**' || 'ğŸš€ **Build triggered by new commit!**' }}
            
            **Status:** ğŸ”„ Building APK...
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** `${{ steps.extract-pr.outputs.head-ref }}` â†’ `${{ steps.extract-pr.outputs.base-ref }}`
            **Commit SHA:** [<code>${{ steps.extract-pr.outputs.short-sha }}</code>](${{ steps.extract-pr.outputs.commit-url }})
            **Workflow:** â³ [Build Pull Request](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            â³ Checking out code and setting up build environment...
            
            ---
            *Current step:* Checking out PR branch...
            
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ steps.extract-pr.outputs.head-repo }}
          ref: ${{ steps.extract-pr.outputs.head-ref }}
          
      - name: Update comment - Setting up environment
        uses: peter-evans/create-or-update-comment@v5
        with:
          comment-id: ${{ steps.initial-comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            # <img src="https://raw.githubusercontent.com/koiverse/ArchiveTune/main/fastlane/metadata/android/en-US/images/icon.png" width="50" height="50" alt="ArchiveTune Logo" style="border-radius: 22%"> ArchiveTune Test Build
            
            ${{ steps.extract-pr.outputs.manual-trigger == 'true' && 'ğŸ”§ **Build triggered manually!**' || 'ğŸš€ **Build triggered by new commit!**' }}
            
            **Status:** âš™ï¸ Setting up build environment...
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** `${{ steps.extract-pr.outputs.head-ref }}` â†’ `${{ steps.extract-pr.outputs.base-ref }}`
            **Commit SHA:** [<code>${{ steps.extract-pr.outputs.short-sha }}</code>](${{ steps.extract-pr.outputs.commit-url }})
            **Workflow:** â³ [Build Pull Request](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            âœ… Code checked out successfully
            
            **Current setup:**
            - âœ… Code checkout completed
            - â³ Setting up Java JDK 17
            - â³ Setting up Android SDK
            - â³ Setting up Gradle build system
            - â³ Generating Android debug keystore
            
            ---
            *Current step:* Configuring Java, Android SDK, and Gradle...
            
      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: "temurin"
          
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 36
          build-tools: 35.0.0
          ndk-version: 26.1.10909125
          cmake-version: 3.22.1
          
      - name: Set Up Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: true
          cache-cleanup: on-success
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Update comment - Generating keystore
        uses: peter-evans/create-or-update-comment@v5
        with:
          comment-id: ${{ steps.initial-comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            # <img src="https://raw.githubusercontent.com/koiverse/ArchiveTune/main/fastlane/metadata/android/en-US/images/icon.png" width="50" height="50" alt="ArchiveTune Logo" style="border-radius: 22%"> ArchiveTune Test Build
            
            ${{ steps.extract-pr.outputs.manual-trigger == 'true' && 'ğŸ”§ **Build triggered manually!**' || 'ğŸš€ **Build triggered by new commit!**' }}
            
            **Status:** ğŸ”‘ Generating debug keystore...
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** `${{ steps.extract-pr.outputs.head-ref }}` â†’ `${{ steps.extract-pr.outputs.base-ref }}`
            **Commit SHA:** [<code>${{ steps.extract-pr.outputs.short-sha }}</code>](${{ steps.extract-pr.outputs.commit-url }})
            **Workflow:** â³ [Build Pull Request](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            âœ… Environment set up:
            - âœ… Java JDK 17
            - âœ… Gradle configured
            - âœ… Build permissions set
            
            **Current task:** Generating Android debug keystore...
            
            ---
            *Current step:* Creating debug signing key...

      - name: Generate debug.keystore if not exists
        run: |
          mkdir -p ~/.android
          if [ ! -f ~/.android/debug.keystore ]; then
            keytool -genkey -v \
              -keystore ~/.android/debug.keystore \
              -storepass android \
              -alias androiddebugkey \
              -keypass android \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -dname "CN=Android Debug,O=Android,C=US"
          fi
          
      - name: Update comment - Building APK
        uses: peter-evans/create-or-update-comment@v5
        with:
          comment-id: ${{ steps.initial-comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            # <img src="https://raw.githubusercontent.com/koiverse/ArchiveTune/main/fastlane/metadata/android/en-US/images/icon.png" width="50" height="50" alt="ArchiveTune Logo" style="border-radius: 22%"> ArchiveTune Test Build
            
            ${{ steps.extract-pr.outputs.manual-trigger == 'true' && 'ğŸ”§ **Build triggered manually!**' || 'ğŸš€ **Build triggered by new commit!**' }}
            
            **Status:** ğŸ—ï¸ Building APK...
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** `${{ steps.extract-pr.outputs.head-ref }}` â†’ `${{ steps.extract-pr.outputs.base-ref }}`
            **Commit SHA:** [<code>${{ steps.extract-pr.outputs.short-sha }}</code>](${{ steps.extract-pr.outputs.commit-url }})
            **Workflow:** â³ [Build Pull Request](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            âœ… All setup complete:
            - âœ… Java JDK 21
            - âœ… Gradle  
            - âœ… Debug keystore
            
            **Now building:** Universal Debug APK...
            
            ---
            *Current step:* Running Gradle build and lint check...

      - name: Build and Lint Universal Debug APK
        id: build-apk
        continue-on-error: true
        run: |
          # Create temporary file to store complete log
          BUILD_LOG=$(mktemp)
          
          # Run gradle build and save all output to file
          set +e
          ./gradlew --console=plain assembleUniversalDebug :app:lintUniversalDebug --warning-mode summary 2>&1 | tee "$BUILD_LOG"
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          # Read full build log
          FULL_LOG=$(cat "$BUILD_LOG")
          
          # Limit log to avoid exceeding output variable size (approx 0.5MB)
          # About 30000 lines or 500000 characters
          TRIMMED_LOG=$(echo "$FULL_LOG" | tail -30000 | head -c 500000)
          
          # Escape special characters for JSON/Markdown
          ESCAPED_LOG=$(echo "$TRIMMED_LOG" | sed -e 's/\\/\\\\/g' -e 's/"/\\"/g' -e 's/`/\\`/g' -e "s/'/\\'/g" -e 's/\$/\$/g')
          
          # Save trimmed log to output
          echo "build-log<<EOF" >> $GITHUB_OUTPUT
          echo "$ESCAPED_LOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Get last 50 lines for summary
          LAST_50_LINES=$(tail -50 "$BUILD_LOG")
          ESCAPED_LAST_50=$(echo "$LAST_50_LINES" | sed -e 's/\\/\\\\/g' -e 's/"/\\"/g' -e 's/`/\\`/g' -e 's/\$/\$/g')
          
          echo "build-output<<EOF" >> $GITHUB_OUTPUT
          echo "$ESCAPED_LAST_50" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Get first error lines for quick display
          ERROR_LINES=$(grep -i "error\|fail\|exception\|failed" "$BUILD_LOG" | head -10)
          if [ -z "$ERROR_LINES" ]; then
            ERROR_LINES="No specific error messages found. Check the full build log."
          fi
          ESCAPED_ERRORS=$(echo "$ERROR_LINES" | sed -e 's/\\/\\\\/g' -e 's/"/\\"/g' -e 's/`/\\`/g' -e 's/\$/\$/g')
          
          echo "error-lines<<EOF" >> $GITHUB_OUTPUT
          echo "$ESCAPED_ERRORS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Check exit code and set build-success accordingly
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "build-success=true" >> $GITHUB_OUTPUT
            echo "Build successful!"
          else
            echo "build-success=false" >> $GITHUB_OUTPUT
            echo "Build failed with exit code: $BUILD_EXIT_CODE"
          fi
          
          # Clean up temporary file
          rm -f "$BUILD_LOG"
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          PULL_REQUEST: "true"
          LASTFM_API_KEY: ${{ secrets.LASTFM_API_KEY }}
          LASTFM_SECRET: ${{ secrets.LASTFM_SECRET }}
          
      - name: Process build result and update comment
        id: process-result
        run: |
          if [ "${{ steps.build-apk.outputs.build-success }}" = "true" ]; then
            echo "Build was successful"
            echo "is-success=true" >> $GITHUB_OUTPUT
          else
            echo "Build failed"
            echo "is-success=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Update comment - Build successful
        if: steps.process-result.outputs.is-success == 'true'
        uses: peter-evans/create-or-update-comment@v5
        with:
          comment-id: ${{ steps.initial-comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            # <img src="https://raw.githubusercontent.com/koiverse/ArchiveTune/main/fastlane/metadata/android/en-US/images/icon.png" width="50" height="50" alt="ArchiveTune Logo" style="border-radius: 22%"> ArchiveTune Test Build
            ## Build test results are available
            
            ${{ steps.extract-pr.outputs.manual-trigger == 'true' && 'ğŸ”§ **Build triggered manually!**' || 'ğŸš€ **Build triggered by new commit!**' }}
            
            **Status:** âœ… **BUILD SUCCESSFUL!**
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** `${{ steps.extract-pr.outputs.head-ref }}` â†’ `${{ steps.extract-pr.outputs.base-ref }}`
            **Commit SHA:** [<code>${{ steps.extract-pr.outputs.short-sha }}</code>](${{ steps.extract-pr.outputs.commit-url }})
            **Workflow:** âœ… [Build Pull Request](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            âœ… All steps completed successfully:
            - âœ… Java JDK 21
            - âœ… Gradle build system  
            - âœ… Debug keystore
            - âœ… APK compilation
            - âœ… Lint check
            
            **Current task:** Uploading APK artifact...
            
            ---
            *Current step:* Uploading artifact to GitHub Actions...

      - name: Update comment - Build failed
        if: steps.process-result.outputs.is-success == 'false'
        uses: peter-evans/create-or-update-comment@v5
        with:
          comment-id: ${{ steps.initial-comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            # <img src="https://raw.githubusercontent.com/koiverse/ArchiveTune/main/fastlane/metadata/android/en-US/images/icon.png" width="50" height="50" alt="ArchiveTune Logo" style="border-radius: 22%"> ArchiveTune Test Build
            ## Build test results are available
            
            ${{ steps.extract-pr.outputs.manual-trigger == 'true' && 'ğŸ”§ **Build triggered manually!**' || 'ğŸš€ **Build triggered by new commit!**' }}
            
            **Status:** âŒ **BUILD FAILED!**
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** `${{ steps.extract-pr.outputs.head-ref }}` â†’ `${{ steps.extract-pr.outputs.base-ref }}`
            **Commit SHA:** [<code>${{ steps.extract-pr.outputs.short-sha }}</code>](${{ steps.extract-pr.outputs.commit-url }})
            **Workflow:** âŒ [Build Pull Request](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            âŒ Build failed during APK compilation
            
            **ğŸ”¥ First errors found:**
            ```bash
            ${{ steps.build-apk.outputs.error-lines }}
            ```
            
            <details>
            <summary>ğŸ“‹ Log Summary (Last 50 lines)</summary>
            
            ```bash
            ${{ steps.build-apk.outputs.build-output }}
            ```
            
            </details>
            
            <details>
            <summary>ğŸ“‹ Full Build Log (Trimmed)</summary>
            
            ```bash
            ${{ steps.build-apk.outputs.build-log }}
            ```
            
            </details>
            
            ğŸ” **Debug tips:**
            1. Check for syntax errors in your code
            2. Verify all dependencies are correctly defined
            3. Ensure API keys and secrets are properly set
            
            ğŸ“Š **Complete logs:** [View in Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) â€¢ [View job logs](${{ steps.job-info.outputs.raw-logs-url }})
            
            ---
            *Note: Log has been trimmed if it was too long. Check the Actions tab for complete logs.*

      - name: Upload APK
        if: steps.process-result.outputs.is-success == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: app-universal-debug-pr-${{ steps.extract-pr.outputs.pr-number }}
          path: app/build/outputs/apk/universal/debug/*.apk
          
      - name: Get artifact information
        if: steps.process-result.outputs.is-success == 'true'
        id: artifact-info
        run: |
          # Get artifact information from GitHub API
          ARTIFACTS_URL="https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts"
          
          echo "Fetching artifacts from: $ARTIFACTS_URL"
          
          ARTIFACTS_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "$ARTIFACTS_URL")
          
          echo "Artifacts response: $ARTIFACTS_JSON"
          
          # Find artifacts with matching names.
          ARTIFACT_NAME="app-universal-debug-pr-${{ steps.extract-pr.outputs.pr-number }}"
          ARTIFACT_ID=$(echo "$ARTIFACTS_JSON" | jq -r ".artifacts[] | select(.name == \"$ARTIFACT_NAME\") | .id")
          
          if [ -n "$ARTIFACT_ID" ] && [ "$ARTIFACT_ID" != "null" ]; then
            echo "Found artifact ID: $ARTIFACT_ID"
            echo "artifact-id=$ARTIFACT_ID" >> $GITHUB_OUTPUT
            
            # Create a direct download URL
            ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/$ARTIFACT_ID"
            echo "artifact-url=$ARTIFACT_URL" >> $GITHUB_OUTPUT
          else
            echo "Warning: Could not find artifact ID for '$ARTIFACT_NAME'"
            echo "artifact-id=0" >> $GITHUB_OUTPUT
            echo "artifact-url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts" >> $GITHUB_OUTPUT
          fi
          
          # Get the current timestamp
          CURRENT_TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          echo "timestamp=$CURRENT_TIMESTAMP" >> $GITHUB_OUTPUT
          
      - name: Update comment - APK uploaded (Final Success)
        if: steps.process-result.outputs.is-success == 'true'
        uses: peter-evans/create-or-update-comment@v5
        with:
          comment-id: ${{ steps.initial-comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            # <img src="https://raw.githubusercontent.com/koiverse/ArchiveTune/main/fastlane/metadata/android/en-US/images/icon.png" width="50" height="50" alt="ArchiveTune Logo" style="border-radius: 22%"> ArchiveTune Test Build
            ## Build test results are available
            
            ${{ steps.extract-pr.outputs.manual-trigger == 'true' && 'ğŸ”§ **Build triggered manually!**' || 'ğŸš€ **Build triggered by new commit!**' }}
            
            **Status:** âœ… **BUILD COMPLETE!**
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** `${{ steps.extract-pr.outputs.head-ref }}` â†’ `${{ steps.extract-pr.outputs.base-ref }}`
            **Commit SHA:** [<code>${{ steps.extract-pr.outputs.short-sha }}</code>](${{ steps.extract-pr.outputs.commit-url }})
            **Workflow:** âœ… [Build Pull Request](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ğŸ‰ **Build successful!** APK is ready for download.
            
            ### ğŸ“¥ Download APK:
            **Artifact name:** `app-universal-debug-pr-${{ steps.extract-pr.outputs.pr-number }}`
            
            [ğŸ“¦ Download APK from Actions Artifacts](${{ steps.artifact-info.outputs.artifact-url }})
            
            ### ğŸ”§ Build Details:
            - **JDK:** 21 (Temurin)
            - **Build Type:** Universal Debug
            - **Keystore:** Debug keystore (auto-generated)
            - **Timestamp:** ${{ steps.artifact-info.outputs.timestamp }}
            
            ### ğŸ“‹ Next Steps:
            1. Download the APK above
            2. Install on Android device/emulator
            3. Test the changes
            4. Report any issues in the PR
            
            ğŸ“Š **Complete logs:** [View in Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) â€¢ [View job logs](${{ steps.job-info.outputs.raw-logs-url }})
            
            ---
            ${{ steps.extract-pr.outputs.manual-trigger == 'true' && '*ğŸ”§ This build was manually triggered via workflow dispatch.*' || '*âœ… This build was automatically triggered by new commit.*' }}

      - name: Check if we need to create backup comment
        id: check-backup
        run: |
          # Check if we have a valid comment-id from initial step
          if [ -n "${{ steps.initial-comment.outputs.comment-id }}" ] && [ "${{ steps.initial-comment.outputs.comment-id }}" != "" ]; then
            echo "We have a valid comment ID: ${{ steps.initial-comment.outputs.comment-id }}"
            echo "need-backup-comment=false" >> $GITHUB_OUTPUT
          else
            echo "No valid comment ID found, need backup comment"
            echo "need-backup-comment=true" >> $GITHUB_OUTPUT
          fi
          
      - name: Create backup comment only if needed
        if: steps.check-backup.outputs.need-backup-comment == 'true'
        uses: peter-evans/create-or-update-comment@v5
        continue-on-error: true
        with:
          issue-number: ${{ steps.extract-pr.outputs.pr-number }}
          body: |
            # <img src="https://raw.githubusercontent.com/koiverse/ArchiveTune/main/fastlane/metadata/android/en-US/images/icon.png" width="50" height="50" alt="ArchiveTune Logo" style="border-radius: 22%"> ArchiveTune Build Result
            
            âš ï¸ **Build status update**
            
            **Status:** ${{ steps.process-result.outputs.is-success == 'true' && 'âœ… BUILD SUCCESSFUL' || 'âŒ BUILD FAILED' }}
            **PR:** #${{ steps.extract-pr.outputs.pr-number }}
            **Branch:** `${{ steps.extract-pr.outputs.head-ref }}` â†’ `${{ steps.extract-pr.outputs.base-ref }}`
            **Commit SHA:** [<code>${{ steps.extract-pr.outputs.short-sha }}</code>](${{ steps.extract-pr.outputs.commit-url }})
            **Workflow:** ${{ steps.process-result.outputs.is-success == 'true' && 'âœ…' || 'âŒ' }} [Build Pull Request](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            *Note: Original comment could not be created or updated.*
            
            ${{ steps.process-result.outputs.is-success == 'true' && 'ğŸ‰ **Build successful!** APK is ready for download.' || 'âŒ **Build failed!** Check the workflow logs for details.' }}
            
            ğŸ“Š **Complete logs:** [View in Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) â€¢ [View job logs](${{ steps.job-info.outputs.raw-logs-url }})
            
            ---
            *This is a backup comment created because the original comment could not be properly managed.*

      - name: Fail job if build failed
        if: steps.process-result.outputs.is-success == 'false'
        run: |
          echo "âŒ Build failed. Marking workflow as failed."
          echo "Check the comment above for detailed error logs."
          exit 1
